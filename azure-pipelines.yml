strategy:
  matrix:
    mac10.14:
      imageName: 'macos-10.14'
    mac10.13:
      imageName: 'macOS-10.13'
    linux:
      imageName: 'ubuntu-16.04'

pool:
  vmImage: $(imageName)

variables:
  HOMEBREW_BINTRAY_USER: 1480c1
  HOMEBREW_GITHUB_API_TOKEN: $(GITHUB_OAUTH_TOKEN)
  HOMEBREW_BINTRAY_KEY: $(BINTRAY_API_TOKEN)

steps:
- bash: |
    set -e
    if [[ -n "$SYSTEM_PULLREQUEST_PULLREQUESTNUMBER" ]]; then
      git fetch origin "master:master" "pull/$SYSTEM_PULLREQUEST_PULLREQUESTNUMBER/head:pr"
      git checkout pr
    fi
    if ! [[ "$(imageName)" =~ "macos*" ]]; then
      sudo chown -R $(whoami) /usr/local
      sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)"
    fi
    test -d ~/.linuxbrew && eval $(~/.linuxbrew/bin/brew shellenv) || { test -d /home/linuxbrew/.linuxbrew && eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv); } || true
  displayName: Setup Brew

- bash: |
    test -d ~/.linuxbrew && eval $(~/.linuxbrew/bin/brew shellenv) || { test -d /home/linuxbrew/.linuxbrew && eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv); } || true
    brew test-bot SVT-AV1 --root-url="https://dl.bintray.com/1480c1/bottles-svt-encoders/" --verbose
  displayName: Run brew test-bot
